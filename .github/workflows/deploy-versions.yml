# Deploy docs with mike so the version selector appears on GitHub Pages.
# All tags in the repo are deployed automatically; the newest (by version sort) is set as "latest".

name: Deploy docs (mike)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: deploy-versions
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: |
          python -m venv .venv
          . .venv/bin/activate
          pip install -r requirements.txt

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create passwords.yml for auth
        run: |
          echo "_global: \"${DOCS_PASSWORD:-docs}\"" > passwords.yml
        env:
          DOCS_PASSWORD: ${{ secrets.DOCS_PASSWORD }}

      - name: Deploy all tags with mike
        run: |
          . .venv/bin/activate
          set -e
          TAGS=$(git tag -l | sort -V)
          if [ -z "$TAGS" ]; then
            echo "No tags found. Push tags (e.g. git push origin --tags) to deploy versions."
            exit 1
          fi
          LATEST=$(echo "$TAGS" | tail -1)
          echo "Deploying tags (version order): $TAGS"
          echo "Latest version (alias 'latest'): $LATEST"
          for tag in $TAGS; do
            echo "Deploying $tag..."
            git checkout "$tag"
            if [ "$tag" = "$LATEST" ]; then
              mike deploy "$tag" latest --push --update-aliases --remote origin
            else
              mike deploy "$tag" --push --remote origin
            fi
          done
          git checkout main
          mike set-default --push latest --remote origin
